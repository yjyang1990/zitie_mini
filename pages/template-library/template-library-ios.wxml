<!--Apple iOS Style æ¨¡æ¿åº“é¡µé¢-->
<import src="../../styles/apple-design-system.wxss"/>

<view class="ios-page template-library-page">
  <!-- iOS Style Navigation Bar -->
  <view class="ios-navbar">
    <view class="navbar-left">
      <button class="nav-button ios-bounce" bind:tap="goBack">
        <text class="nav-icon">â€¹</text>
      </button>
    </view>
    <view class="ios-navbar-title">æ¨¡æ¿åº“</view>
    <view class="navbar-right">
      <button class="nav-button ios-bounce" bind:tap="onViewModeChange" data-mode="{{viewMode === 'grid' ? 'list' : 'grid'}}">
        <text class="nav-icon">{{viewMode === 'grid' ? 'â˜°' : 'âŠ'}}</text>
      </button>
    </view>
  </view>

  <view class="ios-container">
    <!-- Search Bar - iOS Style -->
    <view class="search-section">
      <view class="ios-search-bar ios-glass">
        <view class="search-icon">ğŸ”</view>
        <input class="search-input ios-body" 
               placeholder="æœç´¢æ¨¡æ¿ã€æ ‡ç­¾æˆ–å†…å®¹..." 
               value="{{searchQuery}}"
               bind:input="onSearchInput"
               bind:confirm="onSearchInput" />
        <view wx:if="{{searchQuery}}" class="clear-button ios-bounce" bind:tap="onSearchClear">
          <text class="clear-icon">âœ–ï¸</text>
        </view>
      </view>
    </view>

    <!-- Filter Controls - iOS Control Center Style -->
    <view class="filter-section">
      <scroll-view class="filter-scroll" scroll-x="true" show-scrollbar="false">
        <view class="filter-pills">
          <!-- Category Pills -->
          <view wx:for="{{categories}}" wx:key="id" 
                class="filter-pill {{currentCategory === item.id ? 'active' : ''}} ios-bounce"
                bind:tap="onCategoryChange" 
                data-category="{{item.id}}">
            <view class="pill-icon">{{item.icon}}</view>
            <view class="pill-text ios-footnote">{{item.name}}</view>
          </view>
          
          <!-- Difficulty Filter -->
          <view class="filter-pill {{difficulty > 0 ? 'active' : ''}} ios-bounce"
                bind:tap="showDifficultyPicker">
            <view class="pill-icon">ğŸ¯</view>
            <view class="pill-text ios-footnote">{{difficulty > 0 ? 'éš¾åº¦ ' + difficulty : 'éš¾åº¦'}}</view>
          </view>
          
          <!-- Sort Filter -->
          <view class="filter-pill ios-bounce" bind:tap="showSortPicker">
            <view class="pill-icon">â‡•ï¸</view>
            <view class="pill-text ios-footnote">æ’åº</view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- Stats Header -->
    <view class="stats-header ios-card ios-glass">
      <view class="stats-content">
        <view class="stats-item">
          <view class="stats-number ios-title-3">{{filteredTemplates.length}}</view>
          <view class="stats-label ios-caption">æ¨¡æ¿</view>
        </view>
        <view class="stats-divider"></view>
        <view class="stats-item">
          <view class="stats-number ios-title-3">{{categories.length}}</view>
          <view class="stats-label ios-caption">åˆ†ç±»</view>
        </view>
        <view class="stats-divider"></view>
        <view class="stats-item">
          <view class="stats-number ios-title-3">{{favorites.length}}</view>
          <view class="stats-label ios-caption">æ”¶è—</view>
        </view>
      </view>
    </view>

    <!-- Loading State -->
    <view wx:if="{{loading}}" class="loading-section ios-card">
      <view class="loading-content">
        <view class="loading-spinner">â³</view>
        <view class="loading-text ios-callout">åŠ è½½æ¨¡æ¿ä¸­...</view>
      </view>
    </view>

    <!-- Templates Grid/List -->
    <view wx:if="{{!loading && filteredTemplates.length > 0}}" class="templates-section">
      <!-- Grid View -->
      <view wx:if="{{viewMode === 'grid'}}" class="templates-grid">
        <view wx:for="{{filteredTemplates}}" wx:key="id" 
              class="template-card-grid ios-card ios-bounce" 
              bind:tap="onTemplateClick" 
              data-id="{{item.id}}">
          
          <!-- Card Header -->
          <view class="card-header">
            <view class="template-badge" style="background: {{item.categoryColor}};">
              <text class="badge-icon">{{item.categoryIcon}}</text>
            </view>
            <button class="favorite-btn ios-bounce" 
                    bind:tap="toggleFavorite" 
                    data-id="{{item.id}}"
                    catch:tap="true">
              <text class="favorite-icon">{{favorites.includes(item.id) ? 'â­' : 'â˜†'}}</text>
            </button>
          </view>
          
          <!-- Card Content -->
          <view class="card-content">
            <view class="template-title ios-subhead">{{item.title}}</view>
            <view class="template-preview ios-caption">{{item.contentPreview}}</view>
          </view>
          
          <!-- Card Footer -->
          <view class="card-footer">
            <view class="template-meta">
              <view class="meta-item">
                <text class="meta-icon">ğŸ¯</text>
                <text class="meta-text ios-caption">{{item.difficulty}}/5</text>
              </view>
              <view class="meta-item">
                <text class="meta-icon">âœï¸</text>
                <text class="meta-text ios-caption">{{item.strokeCount}}ç¬”</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- List View -->
      <view wx:if="{{viewMode === 'list'}}" class="templates-list ios-list">
        <view wx:for="{{filteredTemplates}}" wx:key="id" 
              class="ios-list-item template-list-item ios-bounce" 
              bind:tap="onTemplateClick" 
              data-id="{{item.id}}">
          
          <view class="ios-list-icon" style="background: {{item.categoryColor}};">
            <text class="list-icon">{{item.categoryIcon}}</text>
          </view>
          
          <view class="ios-list-content">
            <view class="ios-list-title">{{item.title}}</view>
            <view class="ios-list-subtitle">{{item.contentNote}}</view>
            <view class="template-tags">
              <view class="tag-item">ğŸ¯ {{item.difficulty}}/5</view>
              <view class="tag-item">âœï¸ {{item.strokeCount}}ç¬”</view>
              <view wx:if="{{item.featured}}" class="tag-item featured">â­ æ¨è</view>
            </view>
          </view>
          
          <view class="list-actions">
            <button class="action-btn favorite-action ios-bounce" 
                    bind:tap="toggleFavorite" 
                    data-id="{{item.id}}"
                    catch:tap="true">
              <text class="action-icon">{{favorites.includes(item.id) ? 'â­' : 'â˜†'}}</text>
            </button>
            <view class="ios-list-chevron">â–·</view>
          </view>
        </view>
      </view>
    </view>

    <!-- Empty State -->
    <view wx:if="{{!loading && filteredTemplates.length === 0}}" class="empty-section ios-card">
      <view class="empty-content">
        <view class="empty-icon">ğŸ”</view>
        <view class="empty-title ios-headline">æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡æ¿</view>
        <view class="empty-subtitle ios-callout">å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–ç­›é€‰å™¨</view>
        <button class="ios-button-primary ios-bounce" bind:tap="onSearchClear">
          æ¸…é™¤ç­›é€‰
        </button>
      </view>
    </view>
  </view>

  <!-- Template Preview Modal - iOS Style -->
  <view wx:if="{{showPreview && selectedTemplate}}" class="preview-modal">
    <view class="ios-modal-backdrop" bind:tap="onClosePreview"></view>
    <view class="preview-content ios-card-large">
      <!-- Modal Header -->
      <view class="preview-header">
        <button class="close-btn ios-bounce" bind:tap="onClosePreview">
          <text class="close-icon">âœ–ï¸</text>
        </button>
        <view class="preview-title ios-headline">{{selectedTemplate.title}}</view>
        <button class="share-btn ios-bounce" bind:tap="onShareTemplate" data-id="{{selectedTemplate.id}}">
          <text class="share-icon">ğŸ“¤</text>
        </button>
      </view>
      
      <!-- Template Content -->
      <view class="preview-body">
        <view class="template-content-preview ios-glass">
          <view class="content-text ios-title-2">{{selectedTemplate.content}}</view>
        </view>
        
        <view class="template-details ios-list">
          <view class="ios-list-item">
            <view class="detail-label ios-callout">åˆ†ç±»</view>
            <view class="detail-value ios-callout">{{selectedTemplate.categoryName}}</view>
          </view>
          <view class="ios-list-item">
            <view class="detail-label ios-callout">éš¾åº¦</view>
            <view class="detail-value ios-callout">{{selectedTemplate.difficulty}}/5</view>
          </view>
          <view class="ios-list-item">
            <view class="detail-label ios-callout">ç¬”ç”»æ•°</view>
            <view class="detail-value ios-callout">{{selectedTemplate.strokeCount}}</view>
          </view>
          <view class="ios-list-item">
            <view class="detail-label ios-callout">ä½¿ç”¨é¢‘ç‡</view>
            <view class="detail-value ios-callout">{{selectedTemplate.frequency}}</view>
          </view>
        </view>
      </view>
      
      <!-- Modal Actions -->
      <view class="preview-actions">
        <button class="ios-button-secondary ios-bounce" bind:tap="toggleFavorite" data-id="{{selectedTemplate.id}}">
          {{favorites.includes(selectedTemplate.id) ? 'â¤ï¸ å·²æ”¶è—' : 'ğŸ¤ æ”¶è—'}}
        </button>
        <button class="ios-button-primary ios-bounce" bind:tap="onUseTemplate" data-id="{{selectedTemplate.id}}">
          ä½¿ç”¨æ¨¡æ¿
        </button>
      </view>
    </view>
  </view>

  <!-- Picker Modals -->
  <view wx:if="{{showDifficultyPicker}}" class="picker-modal">
    <view class="ios-modal-backdrop" bind:tap="{{() => setData({showDifficultyPicker: false})}}"></view>
    <view class="picker-content ios-card-large">
      <view class="picker-header ios-headline">é€‰æ‹©éš¾åº¦</view>
      <view class="picker-options">
        <view wx:for="{{[0,1,2,3,4,5]}}" wx:key="*this"
              class="picker-option ios-bounce {{difficulty === item ? 'active' : ''}}"
              bind:tap="onDifficultyChange"
              data-value="{{item}}">
          <text class="option-text ios-callout">{{item === 0 ? 'å…¨éƒ¨' : item + '/5'}}</text>
          <text wx:if="{{difficulty === item}}" class="option-check">âœ“</text>
        </view>
      </view>
    </view>
  </view>

  <view wx:if="{{showSortPicker}}" class="picker-modal">
    <view class="ios-modal-backdrop" bind:tap="{{() => setData({showSortPicker: false})}}"></view>
    <view class="picker-content ios-card-large">
      <view class="picker-header ios-headline">æ’åºæ–¹å¼</view>
      <view class="picker-options">
        <view wx:for="{{sortOptions}}" wx:key="value"
              class="picker-option ios-bounce {{sortBy === item.value ? 'active' : ''}}"
              bind:tap="onSortChange"
              data-value="{{item.value}}">
          <text class="option-text ios-callout">{{item.label}}</text>
          <text wx:if="{{sortBy === item.value}}" class="option-check">âœ“</text>
        </view>
      </view>
    </view>
  </view>
</view>